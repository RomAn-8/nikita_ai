"""Start command handler."""

from telegram import Update
from telegram.ext import ContextTypes

from ..core.errors import safe_reply_text
from ..handlers.base import Handler
from ..services.context_manager import get_mode, get_temperature, get_memory_enabled, get_effective_model
from ..utils.text import _short_model_name
from ..config import OPENROUTER_MODEL
from ..config import MODEL_GLM, MODEL_GEMMA, PR_REVIEW_AVAILABLE


class StartHandler(Handler):
    """Handler for /start command."""
    
    async def handle(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """Handle /start command."""
        agent_context = self.get_agent_context(update, context)
        mode = agent_context.mode
        chat_id = agent_context.chat_id
        t = agent_context.temperature
        mem = agent_context.memory_enabled
        current_model = get_effective_model(context, chat_id)
        
        lines = [
            "–ü—Ä–∏–≤–µ—Ç! üëã",
            "",
            "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:",
            "",
            "üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã:",
            f"/mode_text ‚Äî —Ä–µ–∂–∏–º text + {_short_model_name(OPENROUTER_MODEL)}",
            "/mode_json ‚Äî JSON –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            f"/mode_summary ‚Äî —Ä–µ–∂–∏–º summary + {_short_model_name(OPENROUTER_MODEL)} (—Å–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏)",
            "/summary_debug ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ summary (—Ä–µ–∂–∏–º summary)",
        ]
        
        if MODEL_GLM:
            lines.append(f"/model_glm ‚Äî –º–æ–¥–µ–ª—å {_short_model_name(MODEL_GLM)}")
        if MODEL_GEMMA:
            lines.append(f"/model_gemma ‚Äî –º–æ–¥–µ–ª—å {_short_model_name(MODEL_GEMMA)}")
        
        lines.extend([
            "",
            "ü§ñ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã:",
            "/tz_creation_site ‚Äî —Å–æ–±—Ä–∞—Ç—å –¢–ó –Ω–∞ —Å–∞–π—Ç (–∏—Ç–æ–≥ JSON)",
            "/forest_split ‚Äî –∫—Ç–æ –∫–æ–º—É –¥–æ–ª–∂–µ–Ω (–∏—Ç–æ–≥ —Ç–µ–∫—Å—Ç)",
            "/thinking_model ‚Äî —Ä–µ—à–∞—Ç—å –ø–æ—à–∞–≥–æ–≤–æ",
            "/expert_group_model ‚Äî –≥—Ä—É–ø–ø–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤",
            "",
            "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:",
            "/ch_temperature ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É (–ø—Ä–∏–º–µ—Ä: /ch_temperature 0.7)",
            "/ch_memory ‚Äî –ø–∞–º—è—Ç—å –í–ö–õ/–í–´–ö–õ (–ø—Ä–∏–º–µ—Ä: /ch_memory off)",
            "/clear_memory ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å —á–∞—Ç–∞",
            "/clear_embeddings ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏",
            "",
            "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:",
            "/tokens_test ‚Äî —Ç–µ—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤ (–≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º)",
            "/tokens_next ‚Äî —Ç–µ—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤: —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø",
            "/tokens_stop ‚Äî —Ç–µ—Å—Ç —Ç–æ–∫–µ–Ω–æ–≤: —Å–≤–æ–¥–∫–∞ –∏ –≤—ã—Ö–æ–¥",
            "",
            "üìö RAG –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏:",
            "/embed_create ‚Äî —Å–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏–∑ .md —Ñ–∞–π–ª–∞ (—Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª)",
            "/embed_docs ‚Äî —Å–æ–∑–¥–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ docs/",
            "/rag_model ‚Äî —Ä–µ–∂–∏–º RAG",
            "",
            "üí¨ –°–ª–æ–≤–µ—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–≤ —Ä–µ–∂–∏–º–µ RAG):",
            "‚Ä¢ \"RAG+—Ñ–∏–ª—å—Ç—Ä\" –∏–ª–∏ \"RAG+—Ñ–∏–ª—å—Ç—Ä <–≤–æ–ø—Ä–æ—Å>\" ‚Äî –ø–æ–∏—Å–∫ —Å –ø–æ—Ä–æ–≥–æ–º –ø–æ—Ö–æ–∂–µ—Å—Ç–∏",
            "‚Ä¢ \"RAG –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞\" –∏–ª–∏ \"RAG –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ <–≤–æ–ø—Ä–æ—Å>\" ‚Äî –ø–æ–∏—Å–∫ –±–µ–∑ –ø–æ—Ä–æ–≥–∞",
            "‚Ä¢ \"–ë–µ–∑ RAG\" –∏–ª–∏ \"–ë–µ–∑ RAG <–≤–æ–ø—Ä–æ—Å>\" ‚Äî –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–∏—Å–∫–∞",
            "",
            "üå§Ô∏è –ü–æ–≥–æ–¥–∞:",
            "/weather_sub ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–≥–æ–¥—É (–ø—Ä–∏–º–µ—Ä: /weather_sub –ú–æ—Å–∫–≤–∞ 30)",
            "/weather_sub_stop ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (–ø—Ä–∏–º–µ—Ä: /weather_sub_stop –ú–æ—Å–∫–≤–∞)",
            "/digest ‚Äî —É—Ç—Ä–µ–Ω–Ω—è—è —Å–≤–æ–¥–∫–∞: –ø–æ–≥–æ–¥–∞ + –Ω–æ–≤–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä: /digest –ú–æ—Å–∫–≤–∞, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)",
            "",
            "üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∑–∞–ø–∏—Å–∏:",
            "/register ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–ø—Ä–∏–º–µ—Ä: /register –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á +79991234567)",
            "/unregister ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–≤–æ—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é",
            "/train_signup ‚Äî –∑–∞–ø–∏—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (–ø—Ä–∏–º–µ—Ä: /train_signup 15-02-2026 18:00 [–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ])",
            "/train_move ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏ (–ø—Ä–∏–º–µ—Ä: /train_move 1 16-02-2026 19:00)",
            "/train_cancel ‚Äî –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ (–ø—Ä–∏–º–µ—Ä: /train_cancel 1)",
            "/support ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å RAG (–ø—Ä–∏–º–µ—Ä: /support –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å?)",
            "/task_list ‚Äî —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏ (—Å–ª–æ–≤–µ—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, –ø—Ä–æ—Å–º–æ—Ç—Ä–∞, —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á)",
            "",
            "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç:",
            "/voice ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∞, –¥–ª—è –≤—ã—Ö–æ–¥–∞: /stop –∏–ª–∏ /cancel)",
            "",
            "ü§ñ –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏:",
            "/local_model ‚Äî —Ä–µ–∂–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ Ollama (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞, –∑–∞—Ç–µ–º –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è)",
            "/analyze ‚Äî –∞–Ω–∞–ª–∏–∑ JSON —Ñ–∞–π–ª–æ–≤ —Å –ª–æ–≥–∞–º–∏ —á–µ—Ä–µ–∑ Ollama (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ JSON —Ñ–∞–π–ª, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å)",
            "/me ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–º–∞–Ω–¥—ã: '–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', '–ö—Ç–æ —è?')",
            "",
            "üöÄ –î–µ–ø–ª–æ–π:",
            "/deploy_bot ‚Äî –¥–µ–ø–ª–æ–π –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)",
            "/stop_bot ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–ø—Ü–∏–∏: -v —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, -i —É–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑—ã)",
        ])
        
        if PR_REVIEW_AVAILABLE:
            lines.append("/review_pr ‚Äî –∞–Ω–∞–ª–∏–∑ Pull Request (–ø—Ä–∏–º–µ—Ä: /review_pr 123)")
        
        lines.extend([
            "",
            "üìñ –°–ø—Ä–∞–≤–∫–∞:",
            "/help ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ–µ–∫—Ç–µ",
        ])
        
        lines.extend([
            "",
            f"–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: {mode}",
            f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {t}",
            f"–ü–∞–º—è—Ç—å: {'–í–ö–õ' if mem else '–í–´–ö–õ'}",
            f"–ú–æ–¥–µ–ª—å: {current_model}",
        ])
        
        await safe_reply_text(update, "\n".join(lines))


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Command function for /start."""
    handler = StartHandler()
    await handler.handle(update, context)
